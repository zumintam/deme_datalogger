# ==============================================================================
# Makefile chu·∫©n cho RK3506 - S·ª≠a l·ªói Compiler v√† Path
# ==============================================================================

# 1. TOOLCHAIN (L·∫•y t·ª´ bi·∫øn m√¥i tr∆∞·ªùng RK_SDK_BASE b·∫°n ƒë√£ source)
# RK_SDK_BASE      ?= /home/mtam/tamvm/SDK_rk3506/rk3506_linux6.1_rkr4_v1
TOOLCHAIN_BIN  = $(RK_SDK_BASE)/prebuilts/gcc/linux-x86/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin
CROSS_COMPILE  = $(TOOLCHAIN_BIN)/arm-none-linux-gnueabihf-
CXX            = $(CROSS_COMPILE)g++
CC             = $(CROSS_COMPILE)gcc

# 2. ƒê∆Ø·ªúNG D·∫™N TH∆Ø VI·ªÜN MODBUS (ƒê√£ s·ª≠a l·∫°i theo ls c·ªßa b·∫°n)
MODBUS_DIR     = /home/mtam/tamvm/SDK_rk3506/SDK_rk3506/task_12/libmodbus/build/install
MODBUS_INC     = $(MODBUS_DIR)/include/modbus
MODBUS_LIB     = $(MODBUS_DIR)/lib/libmodbus.a

# 3. C·∫§U TR√öC TH∆Ø M·ª§C NGU·ªíN (ƒê√£ s·ª≠a t√™n meter_driver)
OBJ_DIR        = build
DRV_DIR        = drivers/meter_driver
CJSON_DIR      = components/libcjson

# 4. FLAGS BI√äN D·ªäCH
CXXFLAGS       = -Wall -std=c++11 -O2 -I$(MODBUS_INC) -I$(DRV_DIR) -I$(CJSON_DIR) -I. -D_GNU_SOURCE
LDFLAGS        = -lm $(MODBUS_LIB) -static -lpthread

# 5. DANH S√ÅCH FILE NGU·ªíN
TARGET         = hello_modbus_rtu_cpp
SRCS_CPP       = main.cpp $(DRV_DIR)/meter_driver.cpp $(DRV_DIR)/meter_config.cpp
SRCS_C         = $(CJSON_DIR)/cJSON.c

# Chuy·ªÉn ƒë·ªïi .cpp/.c th√†nh .o trong th∆∞ m·ª•c build
OBJS           = $(patsubst %.cpp,$(OBJ_DIR)/%.o,$(SRCS_CPP)) \
                 $(patsubst %.c,$(OBJ_DIR)/%.o,$(SRCS_C))

# 6. QUY T·∫ÆC BI√äN D·ªäCH
all: $(TARGET)

$(TARGET): $(OBJS)
	@echo "‚ö° Linker: $@"
	$(CXX) $(OBJS) -o $@ $(LDFLAGS)
	@echo "‚úÖ Th√†nh c√¥ng!"

# QUAN TR·ªåNG: S·ª≠a l·ªói thi·∫øu $(CXX) ·ªü ƒë√¢y
$(OBJ_DIR)/%.o: %.cpp
	@mkdir -p $(dir $@)
	@echo "üî® Bi√™n d·ªãch C++: $<"
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(OBJ_DIR)/%.o: %.c
	@mkdir -p $(dir $@)
	@echo "üî® Bi√™n d·ªãch C: $<"
	$(CC) $(CXXFLAGS) -c $< -o $@

clean:
	rm -rf $(OBJ_DIR) $(TARGET)

.PHONY: all clean